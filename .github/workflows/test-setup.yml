name: Test Setup Flow

on:
  workflow_dispatch:
  push:
    paths:
      - 'server/Dockerfile'
      - 'server/docker-compose.yml'
      - 'server/setup.sh'
      - 'server/.env.example'
      - 'server/start.sh'
      - 'server/package.json'
      - 'meet-bot/Dockerfile'
      - 'meet-bot/src/**'
      - 'meet-bot/package.json'
      - '.github/workflows/test-setup.yml'

jobs:
  test-setup:
    name: Test Server Setup
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Verify files exist
        run: |
          echo "=== Checking required files ==="
          for f in server/Dockerfile server/docker-compose.yml server/setup.sh server/.env.example server/start.sh server/package.json server/index.js server/speaker_service.py; do
            if [ -f "$f" ]; then
              echo "✅ $f"
            else
              echo "❌ MISSING: $f"
              exit 1
            fi
          done

      - name: Test setup.sh is executable and valid bash
        run: |
          bash -n server/setup.sh
          echo "✅ setup.sh syntax OK"
          test -x server/setup.sh || chmod +x server/setup.sh
          echo "✅ setup.sh is executable"

      - name: Generate .env (simulating setup.sh)
        run: |
          cd server
          cat > .env << 'EOF'
          GATEWAY_WS_URL=ws://127.0.0.1:18789
          GATEWAY_TOKEN=test-token-for-ci
          USE_GATEWAY_WS=true
          AUTH_TOKEN=ci-test-auth-token
          WHISPER_URL=http://127.0.0.1:9000/asr?language=es&output=json
          TTS_ENGINE=edge
          TTS_VOICE=es-AR-TomasNeural
          KOKORO_URL=http://127.0.0.1:5004
          KOKORO_VOICE=em_alex
          BOT_NAME=jarvis
          OWNER_NAME=CI-Test
          GW_SESSION_KEY=voice
          ASR_MODEL=tiny
          WHISPER_IMAGE=onerahmet/openai-whisper-asr-webservice:latest
          PORT=3200
          WHISPER_PORT=9000
          EOF
          # Remove leading whitespace from heredoc
          sed -i 's/^          //' .env
          echo "✅ .env generated"
          cat .env

      - name: Validate docker-compose.yml
        run: |
          cd server
          docker compose config > /dev/null
          echo "✅ docker-compose.yml is valid"

      - name: Build voice server image
        run: |
          cd server
          docker compose build voice-server
          echo "✅ Voice server image built"

      - name: Start services
        run: |
          cd server
          docker compose up -d
          echo "✅ Services starting..."

      - name: Wait for Whisper
        run: |
          echo "Waiting for Whisper..."
          for i in $(seq 1 90); do
            if curl -sf http://127.0.0.1:9000/docs > /dev/null 2>&1; then
              echo "✅ Whisper is ready (${i}s)"
              break
            fi
            if [ "$i" = "90" ]; then echo "⚠️ Whisper timeout"; fi
            sleep 5
          done

      - name: Wait for Voice Server
        run: |
          echo "Waiting for voice server..."
          for i in $(seq 1 60); do
            if curl -sf http://127.0.0.1:3200/health > /dev/null 2>&1; then
              echo "✅ Voice server is healthy (${i}s)"
              break
            fi
            if [ "$i" = "60" ]; then echo "❌ Voice server timeout"; exit 1; fi
            sleep 2
          done

      - name: Test Whisper transcription
        run: |
          python3 -c "
          import struct
          sr=16000; dur=1; samples=sr*dur
          header = struct.pack('<4sI4s4sIHHIIHH4sI', b'RIFF', 36+samples*2, b'WAVE', b'fmt ', 16, 1, 1, sr, sr*2, 2, 16, b'data', samples*2)
          data = b'\x00\x00' * samples
          open('/tmp/test.wav','wb').write(header + data)
          "
          RESULT=$(curl -sf -F "audio_file=@/tmp/test.wav" "http://127.0.0.1:9000/asr?language=es&output=json" 2>&1) || true
          echo "Whisper response: $RESULT"
          echo "✅ Whisper API responding"

      - name: Test Voice Server health
        run: |
          HEALTH=$(curl -sf http://127.0.0.1:3200/health 2>&1) || true
          echo "Health: $HEALTH"
          echo "✅ Voice server health endpoint OK"

      - name: Show service status
        if: always()
        run: |
          cd server
          echo "=== Container Status ==="
          docker compose ps -a
          echo ""
          echo "=== Voice Server Logs ==="
          docker compose logs voice-server --tail 30 2>&1 || true
          echo ""
          echo "=== Whisper Logs ==="
          docker compose logs whisper --tail 15 2>&1 || true

      - name: Cleanup voice server
        if: always()
        run: |
          cd server
          docker compose down -v 2>/dev/null || true

  test-meet-bot:
    name: Test Meet Bot Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Verify meet-bot files exist
        run: |
          echo "=== Checking meet-bot files ==="
          for f in meet-bot/Dockerfile meet-bot/package.json meet-bot/src/index.js meet-bot/src/config.js meet-bot/src/meet-joiner.js meet-bot/src/ai-responder.js meet-bot/src/audio-pipeline.js meet-bot/src/transcriber.js meet-bot/src/live2d-canvas.js meet-bot/src/calendar-sync.js meet-bot/src/meeting-memory.js meet-bot/scripts/entrypoint.sh; do
            if [ -f "$f" ]; then echo "✅ $f"; else echo "❌ MISSING: $f"; exit 1; fi
          done

      - name: Verify Live2D assets
        run: |
          for model in Mao Hiyori Rice; do
            if [ -f "meet-bot/public/live2d/$model/$model.model3.json" ]; then
              echo "✅ Live2D model: $model"
            else
              echo "❌ Missing Live2D model: $model"
              exit 1
            fi
          done
          test -f meet-bot/public/live2d/live2dcubismcore.min.js && echo "✅ Cubism Core SDK"

      - name: Build meet-bot image
        run: |
          cd meet-bot
          docker build -t meet-bot:ci .
          echo "✅ Meet bot image built"

      - name: Start meet-bot (no external services)
        run: |
          docker run -d --name meet-bot-ci \
            --network host \
            -e GATEWAY_WS_URL=ws://127.0.0.1:18789 \
            -e GATEWAY_TOKEN=ci-test-token \
            -e WHISPER_URL=http://127.0.0.1:9000/asr \
            -e TTS_ENGINE=edge \
            -e BOT_NAME=TestBot \
            -e LIVE2D_ENABLED=true \
            -e LIVE2D_MODEL=Mao \
            meet-bot:ci
          echo "✅ Meet bot container started"

      - name: Wait for meet-bot HTTP API
        run: |
          echo "Waiting for meet-bot..."
          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:3300/health > /dev/null 2>&1; then
              echo "✅ Meet bot is healthy (${i}s)"
              break
            fi
            if [ "$i" = "30" ]; then echo "❌ Meet bot timeout"; exit 1; fi
            sleep 2
          done

      - name: Test meet-bot API endpoints
        run: |
          echo "=== Health ==="
          curl -sf http://127.0.0.1:3300/health | jq .
          echo ""
          echo "=== Status ==="
          curl -sf http://127.0.0.1:3300/status | jq .
          echo ""
          echo "=== Static files (Live2D) ==="
          curl -sf -o /dev/null -w "%{http_code}" http://127.0.0.1:3300/live2d.html
          echo " live2d.html"
          curl -sf -o /dev/null -w "%{http_code}" http://127.0.0.1:3300/live2d/Mao/Mao.model3.json
          echo " Mao.model3.json"
          echo "✅ All endpoints responding"

      - name: Test join validation
        run: |
          # Should return 400 for missing meetLink
          STATUS=$(curl -sf -o /dev/null -w "%{http_code}" -X POST http://127.0.0.1:3300/join -H 'Content-Type: application/json' -d '{}')
          if [ "$STATUS" = "400" ]; then
            echo "✅ Join validation works (400 for missing meetLink)"
          else
            echo "❌ Expected 400, got $STATUS"
            exit 1
          fi

      - name: Show meet-bot logs
        if: always()
        run: |
          echo "=== Meet Bot Logs ==="
          docker logs meet-bot-ci 2>&1 | tail -30

      - name: Cleanup
        if: always()
        run: |
          docker rm -f meet-bot-ci 2>/dev/null || true
