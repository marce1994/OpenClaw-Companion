name: Test Setup Flow

on:
  workflow_dispatch:
  push:
    paths:
      - 'server/Dockerfile'
      - 'server/docker-compose.yml'
      - 'server/setup.sh'
      - 'server/.env.example'
      - 'server/start.sh'
      - 'server/package.json'
      - '.github/workflows/test-setup.yml'

jobs:
  test-setup:
    name: Test Server Setup
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Verify files exist
        run: |
          echo "=== Checking required files ==="
          for f in server/Dockerfile server/docker-compose.yml server/setup.sh server/.env.example server/start.sh server/package.json server/index.js server/speaker_service.py; do
            if [ -f "$f" ]; then
              echo "✅ $f"
            else
              echo "❌ MISSING: $f"
              exit 1
            fi
          done

      - name: Test setup.sh is executable and valid bash
        run: |
          bash -n server/setup.sh
          echo "✅ setup.sh syntax OK"
          test -x server/setup.sh || chmod +x server/setup.sh
          echo "✅ setup.sh is executable"

      - name: Generate .env (simulating setup.sh)
        run: |
          cd server
          cat > .env << 'EOF'
          GATEWAY_WS_URL=ws://127.0.0.1:18789
          GATEWAY_TOKEN=test-token-for-ci
          USE_GATEWAY_WS=true
          AUTH_TOKEN=ci-test-auth-token
          WHISPER_URL=http://127.0.0.1:9000/asr?language=es&output=json
          TTS_ENGINE=edge
          TTS_VOICE=es-AR-TomasNeural
          KOKORO_URL=http://127.0.0.1:5004
          KOKORO_VOICE=em_alex
          BOT_NAME=jarvis
          OWNER_NAME=CI-Test
          GW_SESSION_KEY=voice
          ASR_MODEL=tiny
          WHISPER_IMAGE=onerahmet/openai-whisper-asr-webservice:latest
          GPU_DRIVER=none
          PORT=3200
          WHISPER_PORT=9000
          EOF
          # Remove leading whitespace from heredoc
          sed -i 's/^          //' .env
          echo "✅ .env generated"
          cat .env

      - name: Validate docker-compose.yml
        run: |
          cd server
          docker compose --profile cpu config > /dev/null
          echo "✅ docker-compose.yml is valid"

      - name: Build voice server image
        run: |
          cd server
          docker compose --profile cpu build voice-server
          echo "✅ Voice server image built"

      - name: Pull Whisper CPU image
        run: |
          cd server
          docker compose --profile cpu pull whisper-cpu
          echo "✅ Whisper CPU image pulled"

      - name: Start services (CPU mode)
        run: |
          cd server
          # Start whisper-cpu (CPU profile) + voice-server
          # voice-server depends on 'whisper' which won't start (no GPU),
          # so we start them individually
          docker compose --profile cpu up -d whisper-cpu
          echo "Waiting for Whisper CPU..."
          for i in $(seq 1 90); do
            if curl -sf http://127.0.0.1:9000/docs > /dev/null 2>&1; then
              echo "✅ Whisper CPU is ready (${i}s)"
              break
            fi
            if [ "$i" = "90" ]; then echo "⚠️ Whisper timeout"; fi
            sleep 5
          done
          # Start voice server without depends_on check
          docker compose --profile cpu up -d --no-deps voice-server
          echo "✅ Services starting..."

      - name: Wait for Voice Server
        run: |
          echo "Waiting for voice server..."
          for i in $(seq 1 60); do
            if curl -sf http://127.0.0.1:3200/health > /dev/null 2>&1; then
              echo "✅ Voice server is healthy (${i}s)"
              break
            fi
            if [ "$i" = "60" ]; then echo "❌ Voice server timeout"; exit 1; fi
            sleep 2
          done

      - name: Test Whisper transcription
        run: |
          python3 -c "
          import struct
          sr=16000; dur=1; samples=sr*dur
          header = struct.pack('<4sI4s4sIHHIIHH4sI', b'RIFF', 36+samples*2, b'WAVE', b'fmt ', 16, 1, 1, sr, sr*2, 2, 16, b'data', samples*2)
          data = b'\x00\x00' * samples
          open('/tmp/test.wav','wb').write(header + data)
          "
          RESULT=$(curl -sf -F "audio_file=@/tmp/test.wav" "http://127.0.0.1:9000/asr?language=es&output=json" 2>&1) || true
          echo "Whisper response: $RESULT"
          echo "✅ Whisper API responding"

      - name: Test Voice Server health
        run: |
          HEALTH=$(curl -sf http://127.0.0.1:3200/health 2>&1) || true
          echo "Health: $HEALTH"
          echo "✅ Voice server health endpoint OK"

      - name: Show service status
        if: always()
        run: |
          cd server
          echo "=== Container Status ==="
          docker compose --profile cpu ps -a
          echo ""
          echo "=== Voice Server Logs ==="
          docker compose --profile cpu logs voice-server --tail 30 2>&1 || true
          echo ""
          echo "=== Whisper Logs ==="
          docker compose --profile cpu logs whisper-cpu --tail 15 2>&1 || true

      - name: Cleanup
        if: always()
        run: |
          cd server
          docker compose --profile cpu down -v 2>/dev/null || true
